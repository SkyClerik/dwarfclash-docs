<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.15.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Dwarf Clash Game: Проект Test6: Оптимизация и исправление сортировки толпы 2D-персонажей Spine на GPU</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Dwarf Clash Game
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.15.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('md__dwarf-clash-game_2_assets_2_test_2_test6_2_g_e_m_i_n_i.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Проект Test6: Оптимизация и исправление сортировки толпы 2D-персонажей Spine на GPU </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md145"></a></p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md146"></a>
Цель</h1>
<p>Добиться корректной GPU-сортировки для толпы 2D-персонажей из <a class="el" href="namespace_spine.html">Spine</a> с прозрачными элементами, включая глобальную сортировку персонажей и локальную сортировку частей тела, учитывая вращение камеры, без нагрузки на CPU.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md147"></a>
Проблемы и подходы</h1>
<p>Изначально CPU-сортировка оказалась слишком медленной. Было принято решение перенести тяжелую работу на GPU с помощью compute-шейдеров.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md148"></a>
Текущее состояние (после всех изменений)</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md149"></a>
Файлы и их назначение</h2>
<ul>
<li><b><span class="tt"><a class="el" href="_g_p_u_crowd_manager_8cs_source.html">GPUCrowdManager.cs</a></span> (C# скрипт):</b><ul>
<li>Регистрирует Spine-персонажей (<span class="tt"><a class="el" href="class_g_p_u_crowd_renderer.html">GPUCrowdRenderer</a></span>).</li>
<li>Собирает данные о скелетах, костях, частях (квадах) и текстурах.</li>
<li>Подготавливает Compute Buffers для передачи данных на GPU.</li>
<li>В <span class="tt">LateUpdate()</span>:<ul>
<li>Обновляет данные костей.</li>
<li>Передает матрицу вида камеры (<span class="tt">_ViewMatrix</span>) в <span class="tt">Deconstruct.compute</span>.</li>
<li>Вызывает <span class="tt">deconstructionShader.Dispatch()</span> для обработки частей.</li>
<li>Вызывает <span class="tt">RunSortingShader()</span> для выполнения Bitonic Sort.</li>
<li>Вызывает <span class="tt">DrawCrowd()</span> для отрисовки инстансированных мешей.</li>
</ul>
</li>
<li><b>Логирование:</b> Содержит логирование <span class="tt">DrawOrder</span> от <a class="el" href="namespace_spine.html">Spine</a> для каждого скелета при вызове <span class="tt">RebuildAndUploadData()</span>.</li>
</ul>
</li>
<li><b><span class="tt">Deconstruct.compute</span> (Compute Shader):</b><ul>
<li>Получает данные о скелетах, костях и определениях частей (<a class="el" href="struct_body_part_definition.html">BodyPartDefinition</a>).</li>
<li>Для каждого квада:<ul>
<li>Переводит локальные координаты вершин в мировое пространство, используя матрицу кости.</li>
<li>Преобразует мировые координаты вершин в View Space (<span class="tt">viewPos0</span>, <span class="tt">viewPos0</span>, <span class="tt">viewPos2</span>, <span class="tt">viewPos3</span>).</li>
<li>Вычисляет <span class="tt">quadViewZ</span> как среднюю Z-позицию квада в View Space.</li>
<li>Вычисляет <span class="tt">sortingZ</span> как <span class="tt">quadViewZ - (partId - skelInstance.startPartIndex) * 0.001f;</span>.<ul>
<li><span class="tt">quadViewZ</span>: отвечает за глобальную сортировку персонажей по их Z-глубине относительно камеры.</li>
<li><span class="tt">-(partId - skelInstance.startPartIndex) * 0.001f;</span>: отвечает за локальную сортировку элементов внутри персонажа. Используется вычитание для обеспечения порядка "от дальнего к ближнему" при сортировке по убыванию Z.</li>
</ul>
</li>
<li>Записывает преобразованные данные в <span class="tt">_OutputBodyPartBuffer</span>.</li>
</ul>
</li>
<li><b>Работает с Z-конвенцией:</b> "Чем больше Z, тем дальше объект".</li>
</ul>
</li>
<li><b><span class="tt">BitonicSort.compute</span> (Compute Shader):</b><ul>
<li>Реализует алгоритм Bitonic Sort для сортировки элементов в <span class="tt">_OutputBodyPartBuffer</span>.</li>
<li>Сортирует по полю <span class="tt">sortingZ</span>.</li>
<li><b>Направление сортировки:</b> Условие <span class="tt">if ((item1.sortingZ &gt; item2.sortingZ) == sortDirection)</span> заставляет шейдер сортировать по <b>убыванию <span class="tt">sortingZ</span></b>. Это обеспечивает порядок отрисовки <b>от дальнего к ближнему</b>, что необходимо для корректной отрисовки прозрачных объектов.</li>
</ul>
</li>
<li><b><span class="tt">GPUInstancedCrowd.shader</span> (Render Shader):</b><ul>
<li>Получает отсортированные данные из <span class="tt">_PartsBuffer</span> (который является <span class="tt">_OutputBodyPartBuffer</span>).</li>
<li>Вершинный шейдер (<span class="tt">vert</span>):<ul>
<li>Выбирает нужную вершину квада.</li>
<li>Преобразует мировую позицию в View Space.</li>
<li><b>Заменяет Z-координату в View Space на <span class="tt">part.sortingZ</span></b> (отсортированное значение).</li>
<li>Проецирует вершину в клиповое пространство.</li>
</ul>
</li>
<li>Фрагментный шейдер (<span class="tt">frag</span>):<ul>
<li>Сэмплирует правильную текстуру из Texture2DArray.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md150"></a>
Как это работает</h1>
<ol type="1">
<li><b>Сбор данных (CPU <span class="tt"><a class="el" href="_g_p_u_crowd_manager_8cs_source.html">GPUCrowdManager.cs</a></span>):</b> Для каждого зарегистрированного Spine-персонажа и каждого его видимого слота собираются необходимые данные (текстура, привязка к скелету/кости, локальные вершины и UV) и упаковываются в <span class="tt"><a class="el" href="struct_body_part_definition.html">BodyPartDefinition</a></span>.</li>
<li><b>Обновление костей (CPU <span class="tt"><a class="el" href="_g_p_u_crowd_manager_8cs_source.html">GPUCrowdManager.cs</a></span>):</b> Положения костей каждого скелета обновляются и передаются на GPU.</li>
<li><b>Деконструкция и расчет <span class="tt">sortingZ</span> (GPU <span class="tt">Deconstruct.compute</span>):</b> Для каждой <span class="tt"><a class="el" href="struct_body_part_definition.html">BodyPartDefinition</a></span> на GPU вычисляются финальные мировые координаты вершин. Затем вычисляется <span class="tt">quadViewZ</span> (средняя Z квада в View Space) и комбинируется с локальным смещением <span class="tt">-(partId - skelInstance.startPartIndex) * 0.001f;</span> для получения <span class="tt">sortingZ</span>. <span class="tt">sortingZ</span> отражает как глобальную позицию квада, так и его локальное положение внутри скелета.</li>
<li><b>Сортировка (GPU <span class="tt">BitonicSort.compute</span>):</b> Все квады из <span class="tt">_OutputBodyPartBuffer</span> сортируются по их <span class="tt">sortingZ</span> в порядке убывания. Это гарантирует, что более дальние квады будут иметь более высокое <span class="tt">sortingZ</span> и будут обработаны раньше, чем более ближние, обеспечивая правильный порядок отрисовки для прозрачных объектов.</li>
<li><b>Отрисовка (GPU <span class="tt">GPUInstancedCrowd.shader</span>):</b> Вершинный шейдер использует отсортированное <span class="tt">sortingZ</span> для Z-координаты вершины в View Space, обеспечивая правильный порядок отрисовки каждого квада. Фрагментный шейдер просто отрисовывает текстуру.</li>
</ol>
<h1 class="doxsection"><a class="anchor" id="autotoc_md151"></a>
Текущие проблемы и задачи</h1>
<ul>
<li>Несмотря на теоретически корректную логику <span class="tt">sortingZ</span> и сортировки, визуально "ноги вылезают на передний план" для некоторых персонажей.</li>
<li>Порядок <span class="tt">DrawOrder</span> из лога показывает, что "L Leg" и "R Leg" идут первыми (самые дальние), что соответствует правильному порядку отрисовки от дальнего к ближнему. Противоречие между ожидаемым и фактическим поведением.</li>
<li>Возможно, величина локального смещения (<span class="tt">0.001f</span>) слишком мала, или есть нюансы с <span class="tt">DrawOrder</span> <a class="el" href="namespace_spine.html">Spine</a>, или Z-Fighting. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.15.0 </li>
  </ul>
</div>
</body>
</html>
